<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ECG Viewer (World-class v5, normalized)</title>
<style>
  :root{
    --paper:#fff7f7;
    --trace:#111;
    --grid1:rgba(205,40,40,0.18);
    --grid5:rgba(205,40,40,0.44);
    --text:#141414;
    --muted:#5c5c5c;
    --panel:#ffffff;
    --border:#e2d6d6;
    --btn:#f7f0f0;
    --btn2:#efe3e3;
    --pill:#fff;
  }
  body{background:#f3f3f3;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;}
  h2{margin:0 0 10px 0;font-weight:650;letter-spacing:0.2px}
  .bar{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    background:var(--panel); border:1px solid var(--border); border-radius:12px;
    padding:10px 12px; margin:10px 0 12px 0;
    box-shadow:0 1px 0 rgba(0,0,0,0.04);
  }
  .bar label{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:13px}
  select{
    background:#fff; color:var(--text); border:1px solid var(--border); border-radius:8px;
    padding:6px 8px; font-size:13px;
  }
  button{
    background:var(--btn); color:var(--text); border:1px solid var(--border); border-radius:10px;
    padding:7px 10px; font-size:13px; cursor:pointer;
  }
  button:hover{background:var(--btn2)}
  .pill{padding:4px 8px;border-radius:999px;background:var(--pill);border:1px solid var(--border);color:var(--muted);font-size:12px}
  .wrap{border:1px solid var(--border); border-radius:14px; overflow:hidden; background:var(--paper);}
  canvas{display:block; width:100%; height:880px; background:var(--paper);}
  .footer{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid var(--border);border-radius:6px;padding:1px 6px;color:var(--text)}
</style>
</head>
<body>
<h2>Pediatric 15-Lead ECG (normalized schema)</h2>

<div class="bar">
  <label>Layout
    <select id="layout">
      <option value="stacked" selected>Stacked (15 leads)</option>
      <option value="print12">12-lead print + rhythm</option>
    </select>
  </label>
  <label>Speed
    <select id="speed">
      <option value="25" selected>25 mm/s</option>
      <option value="50">50 mm/s</option>
    </select>
  </label>
  <label>Gain
    <select id="gain">
      <option value="5">5 mm/mV</option>
      <option value="10" selected>10 mm/mV</option>
      <option value="20">20 mm/mV</option>
    </select>
  </label>
  <label>Paper scale
    <select id="pxmm">
      <option value="4" selected>Fit (recommended)</option>
      <option value="6">Medium</option>
      <option value="8">Large</option>
    </select>
  </label>
  <button id="calBtn">Calipers: OFF</button>
  <button id="clearBtn">Clear</button>
  <span class="pill" id="info">Loading…</span>
  <span class="hint" style="color:var(--muted);font-size:12px">Use <span class="kbd">C</span> for calipers</span>
</div>

<div class="wrap">
  <canvas id="c"></canvas>
</div>

<div class="footer" id="footer"></div>

<script type="module">
import { fetchECG, fmtBpm } from "./js/ecg-core.js";

const DATA_URL = "../data/ecg_data_v5_world_class.json";
const leads15 = ["I","II","III","aVR","aVL","aVF","V1","V2","V3","V4","V5","V6","V3R","V4R","V7"];
const printGrid = [
  ["I","aVR","V1","V4"],
  ["II","aVL","V2","V5"],
  ["III","aVF","V3","V6"],
];

let META = null;
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d",{alpha:false});
const elLayout = document.getElementById("layout");
const elSpeed = document.getElementById("speed");
const elGain = document.getElementById("gain");
const elPxmm = document.getElementById("pxmm");
const elInfo = document.getElementById("info");
const elFooter = document.getElementById("footer");

let calipers = false;
let pts = [];

function resizeCanvas(){
  const cssW = canvas.clientWidth || 1200;
  const cssH = canvas.clientHeight || 880;
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

function pxPerMm(){ return +elPxmm.value; }
function speed(){ return +elSpeed.value; }
function gain(){ return +elGain.value; }
function pxPerSec(){ return speed()*pxPerMm(); }
function pxPerUv(){ return (gain()*pxPerMm())/1000.0; }
function cssSize(){
  return {
    w: canvas.clientWidth || canvas.width,
    h: canvas.clientHeight || canvas.height
  };
}

function drawGrid(){
  const {w,h} = cssSize();
  const p = pxPerMm();
  ctx.clearRect(0,0,w,h);
  ctx.lineWidth=1;
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--grid1");
  ctx.beginPath();
  for(let x=0;x<=w;x+=p){ ctx.moveTo(x,0); ctx.lineTo(x,h); }
  for(let y=0;y<=h;y+=p){ ctx.moveTo(0,y); ctx.lineTo(w,y); }
  ctx.stroke();
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--grid5");
  ctx.beginPath();
  for(let x=0;x<=w;x+=p*5){ ctx.moveTo(x,0); ctx.lineTo(x,h); }
  for(let y=0;y<=h;y+=p*5){ ctx.moveTo(0,y); ctx.lineTo(w,y); }
  ctx.stroke();
}

function drawCalibration(x0,y0){
  const p = pxPerMm();
  ctx.strokeStyle="#111";
  ctx.beginPath();
  ctx.moveTo(x0,y0);
  ctx.lineTo(x0,y0-10*p);
  ctx.lineTo(x0+0.2*pxPerSec(), y0-10*p);
  ctx.lineTo(x0+0.2*pxPerSec(), y0);
  ctx.stroke();
}

function drawStacked(){
  const fs = META.fs;
  const pps = pxPerSec();
  const ppu = pxPerUv();
  const hLead = 60;
  const left = 50;
  const top = 40;
  const step = Math.max(1, Math.floor(fs / pps));
  drawCalibration(left, top + hLead/2);
  let y = top;
  for(const lead of leads15){
    const base = y + hLead/2;
    const data = META.leads_uV[lead];
    ctx.beginPath();
    for(let i=0;i<data.length;i+=step){
      const x = left + (i/fs)*pps;
      const yy = base - data[i]*ppu;
      if(i===0) ctx.moveTo(x,yy); else ctx.lineTo(x,yy);
    }
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--trace");
    ctx.stroke();
    ctx.fillStyle="#444";
    ctx.fillText(lead, 10, base+4);
    y += hLead;
  }
  elFooter.textContent = `Duration ${META.duration_s ?? (META.leads_uV.I.length/fs)} s • Leads ${leads15.length} • Integrity: Einthoven ≤ ${META.integrity?.einthoven_max_abs_error_uV || "—"} µV`;
}

function drawPrint12(){
  const fs = META.fs;
  const pps = pxPerSec();
  const ppu = pxPerUv();
  const {w,h} = cssSize();
  const leftPad = 30;
  const topPad = 30;
  const cols = 4, rows = 3;
  const cellW = (w - leftPad*2)/cols;
  const cellH = (h - topPad*2)/rows;
  const step = Math.max(1, Math.floor(fs / pps));

  drawCalibration(leftPad + 6, topPad + cellH - 10);

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const lead = printGrid[r][c];
      const x0 = leftPad + c*cellW;
      const y0 = topPad + r*cellH;
      const base = y0 + cellH/2;
      ctx.beginPath();
      const data = META.leads_uV[lead];
      for(let i=0;i<data.length;i+=step){
        const x = x0 + (i/fs)*pps;
        const y = base - data[i]*ppu;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--trace");
      ctx.stroke();
      ctx.fillStyle="#444";
      ctx.fillText(lead, x0+6, y0+14);
    }
  }
  const left = leftPad + cellW*0;
  const right = leftPad + cellW*3;
  const base = topPad + rows*cellH - cellH*0.35;
  const rhythmLead = META.leads_uV.II;
  ctx.beginPath();
  const stepR = Math.max(1, Math.floor(fs / pps));
  for(let i=0;i<rhythmLead.length;i+=stepR){
    const x = left + (i/fs)*pps;
    if(x>right) break;
    const y = base - rhythmLead[i]*ppu;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.fillText("II rhythm", left+6, base - 10);
  elFooter.textContent = `Print layout • ${fmtBpm(META.targets?.HR_bpm)} target HR`;
}

function draw(){
  if(!META) return;
  resizeCanvas();
  drawGrid();
  if(elLayout.value==="print12") drawPrint12(); else drawStacked();
  drawCalipers();
  elInfo.textContent = `${speed()} mm/s • ${gain()} mm/mV • ${pxPerMm()} px/mm`;
}

function drawCalipers(){
  if(!calipers || pts.length===0) return;
  ctx.strokeStyle="#1b6dff";
  ctx.fillStyle="#1b6dff";
  ctx.beginPath();
  for(const p of pts){
    ctx.moveTo(p.x-4,p.y); ctx.lineTo(p.x+4,p.y);
    ctx.moveTo(p.x,p.y-4); ctx.lineTo(p.x,p.y+4);
  }
  if(pts.length===2){
    ctx.moveTo(pts[0].x, pts[0].y);
    ctx.lineTo(pts[1].x, pts[1].y);
    const dt = Math.abs(pts[1].x - pts[0].x) / pxPerSec();
    ctx.stroke();
    ctx.fillText(`${Math.round(dt*1000)} ms`, (pts[0].x+pts[1].x)/2, Math.min(pts[0].y, pts[1].y)-6);
  } else {
    ctx.stroke();
  }
}

canvas.addEventListener("click",(e)=>{
  if(!calipers) return;
  const r = canvas.getBoundingClientRect();
  pts.push({x:e.clientX - r.left, y:e.clientY - r.top});
  if(pts.length>2) pts = pts.slice(-2);
  draw();
});

document.addEventListener("keydown",(e)=>{
  if(e.key.toLowerCase()==="c"){ calipers=!calipers; document.getElementById("calBtn").textContent = `Calipers: ${calipers?"ON":"OFF"}`; }
});

document.getElementById("calBtn").onclick = ()=>{
  calipers=!calipers;
  document.getElementById("calBtn").textContent = `Calipers: ${calipers?"ON":"OFF"}`;
  draw();
};
document.getElementById("clearBtn").onclick = ()=>{ pts=[]; draw(); };
elLayout.onchange = draw;
elSpeed.onchange = draw;
elGain.onchange = draw;
elPxmm.onchange = draw;
window.addEventListener("resize", draw);

fetchECG(DATA_URL).then(meta=>{
  META = meta;
  draw();
}).catch(err=>{
  console.error(err);
  elInfo.textContent = "Failed to load ECG";
  elFooter.textContent = err.toString();
});
</script>
</body>
</html>
